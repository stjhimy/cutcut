#!/usr/bin/env ruby

require 'cutcut'
require 'optparse'
require 'ruby-progressbar'

options = {}
OptionParser.new do |opt|
  opt.on('--convert', 'Convert all videos in a folder') { options[:convert] = true }
  opt.on('--copy-metadata', 'Copy original video metadata') { options[:copy_metadata] = true }
  opt.on('--scale', 'SCALE_RESOLUTION') { |e| options[:scale] = e}
end.parse!

pwd = ENV['PWD']
options[:input_dir] ||= pwd
options[:copy_metadata] ||= false

files = Dir[File.join(options[:input_dir], '/*.mp4')]
progressbar = ProgressBar.create(title: 'Converting', starting_at: 0, total: files.count)

puts "#{files.count} files found"

files.each do |file|
  media = CutCut::Media.new(input_file: file)
  scale = options[:scale] || "1920:1080"
  media.convert(copy_metadata: options[:copy_metadata], scale: scale)
  progressbar.increment
end

puts "\n Finished!"
